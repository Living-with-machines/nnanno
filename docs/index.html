---

title: nnanno


keywords: fastai
sidebar: home_sidebar

summary: "Sample, annotate and apply computer vision models to the Newspaper Navigator dataset  "
description: "Sample, annotate and apply computer vision models to the Newspaper Navigator dataset  "
nb_path: "nbs/index.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://github.com/davanstrien/nnanno/workflows/CI/badge.svg" alt="CI"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="tl;dr">tl;dr<a class="anchor-link" href="#tl;dr"> </a></h2><p><code>nnanno</code> is a modest collection of tools to help work with the delightful <a href="https://news-navigator.labs.loc.gov/">Newspaper Navigator</a> data.</p>
<h2 id="nnanno">nnanno<a class="anchor-link" href="#nnanno"> </a></h2><p><a href="https://news-navigator.labs.loc.gov/">Newspaper Navigator</a> is a project which extracted visual content (pictures, maps etc.) from the Library of Congress <a href="https://chroniclingamerica.loc.gov/">Chronicling America</a> digitised newspaper collection.</p>
<p>Newspaper Navigator has released data in a number of formats including <code>json</code> files which contain a range of metadata about the newspaper from which the image was taken from. <code>nnanno</code> was thrown together to help work with this collection as part of the preparation of some example datasets used in a series of Programming Historian tutorials (currently under review). Since this code was developed using the wonderful <a href="nbdev.fast.ai/">nbdev</a> library it is possible to install it for your own use.</p>
<h2 id="What-nnanno-tries-to-help-with">What nnanno tries to help with<a class="anchor-link" href="#What-nnanno-tries-to-help-with"> </a></h2><p>nnanno doesn't to provide an end-to-end to end software for using machine learning with the Newspaper Navigator data. Instead it is a minimal collection of code that <em>may</em> help you if you want to work with the Newspaper Navigator data.</p>
<p>There are three particular areas where nnanno tries to help a little:</p>
<ul>
<li>sampling subsets from the full Newspaper Navigator data</li>
<li>annotating this sample with additional labels using <a href="https://labelstud.io">label studio</a></li>
<li>inference (experimental üò¨) running inference i.e making new predictions with a machine learning model on the newspaper navigator dataset using IIIF.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Disclaimer">Disclaimer<a class="anchor-link" href="#Disclaimer"> </a></h3><p>This code was written mainly to help develop some example datasets for a series of Programming Historian tutorials. It has some tests but there are likely bugs and issues with the code. The code in this repository was all written in notebooks, some people  hate notebooks. Those people will probably hate this too ü§∑‚Äç‚ôÇÔ∏è</p>
<p>If you want to work with the full Newspaper Navigator data you will likely be better of accessing it via the provided S3 bucket see <a href="">news-navigator.labs.loc.gov/</a> for more information.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="nbdev-notes">nbdev notes<a class="anchor-link" href="#nbdev-notes"> </a></h2><p>This code was written using <code>nbdev</code>. This is a tool that helps use Jupyter notebooks for developing Python libraries. Inside the documentation you will see code cells followed by output. This is generated from a Jupyter notebook and shows the actual output of the code rather than something that has been copied and pasted for example:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="nb">print</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2021-02-02
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Is evaluated as Python code. This also means all of the documentation and examples can be opened in notebooks and the code inspected, changed and run.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install"> </a></h2><p>You can install <code>nnanno</code> via GitHub:</p>
<p><code>pip install git+https://github.com/Living-with-machines/nnanno</code></p>
<p>This will install all of the code for sampling from Newspaper Navigator data.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Optional-extra-packages">Optional extra packages<a class="anchor-link" href="#Optional-extra-packages"> </a></h2><p>If you want to use all of the parts of <code>nnanno</code> you'll need to install some extra packages.</p>
<h3 id="label-studio">label studio<a class="anchor-link" href="#label-studio"> </a></h3><p>If you also want to use <code>label-studio</code> for annotating you will need to install this too. There are various ways in which you may want to install label-studio. See the label studio <a href="https://labelstud.io/">documentation</a> for various options for setting this up.</p>
<h3 id="fastai">fastai<a class="anchor-link" href="#fastai"> </a></h3><p>If you want to use the experimental inference functionality you will need to install fastai. See the <a href="https://docs.fast.ai/#Installing">fastai docs</a> for options for doing this.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Documentation">Documentation<a class="anchor-link" href="#Documentation"> </a></h2><p>The <a href="https://living-with-machines.github.io/nnanno/">documentation</a> can be viewed as rendered pages with the option of opening as notebooks in Google Colab.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Illustrations-in-advertising:-an-'end-to-end'-example-of-using-nnanno">Illustrations in advertising: an 'end-to-end' example of using nnanno<a class="anchor-link" href="#Illustrations-in-advertising:-an-'end-to-end'-example-of-using-nnanno"> </a></h2><p>You can find an 'end-to-end' example in <a href="https://living-with-machines.github.io/nnanno/intro.html">examples folder of the documentation</a>.</p>
<p>This example goes through the process of sampling, annotating, training a model and predicting this against the newspaper navigator data.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Functionality">Functionality<a class="anchor-link" href="#Functionality"> </a></h2><p>The three main areas of <code>nnanno</code> are shown below. The examples in the documentation and in the "end-to-end" example shows this functionality in more detail.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Creating-samples">Creating samples<a class="anchor-link" href="#Creating-samples"> </a></h3><p><code>nnanno</code> can be used to create samples from the Newspaper Navigator data:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nnanno.sample</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sampler</span> <span class="o">=</span> <span class="n">nnSampler</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">create_sample</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                           <span class="s1">&#39;photos&#39;</span><span class="p">,</span>
                           <span class="n">start_year</span><span class="o">=</span><span class="mi">1850</span><span class="p">,</span> 
                           <span class="n">end_year</span><span class="o">=</span><span class="mi">1855</span><span class="p">,</span> 
                           <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This returns a dataframe containing samples from the Newspaper Navigator data (loaded via JSON) into a Pandas DataFrame.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">columns</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Index([&#39;filepath&#39;, &#39;pub_date&#39;, &#39;page_seq_num&#39;, &#39;edition_seq_num&#39;, &#39;batch&#39;,
       &#39;lccn&#39;, &#39;box&#39;, &#39;score&#39;, &#39;ocr&#39;, &#39;place_of_publication&#39;,
       &#39;geographic_coverage&#39;, &#39;name&#39;, &#39;publisher&#39;, &#39;url&#39;, &#39;page_url&#39;],
      dtype=&#39;object&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Annotation">Annotation<a class="anchor-link" href="#Annotation"> </a></h3><p>The annotation part of nnanno is mainly a little bit of documentation and a few functions to help setup annotation of a sample from Newspaper Navigator using IIIF urls and the <a href="https://labelstud.io/">label studio</a> annotation tool. Since we can annotate via IIIF this offers a way of annotating without having to download large amounts of data locally.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nnanno.annotate</span> <span class="kn">import</span> <span class="n">create_label_studio_json</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Inference">Inference<a class="anchor-link" href="#Inference"> </a></h3><p>The inference section of nnanno <em>attempts</em> to show one possible way to use IIIF to run inference against samples of Newspaper Navigator using a trained <a href="https://docs.fast.ai/">fastai</a> model. This will allow you to make predictions against larger parts of the Newspaper Navigator data.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nnanno.inference</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.vision.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">ImageDataLoaders</span><span class="o">.</span><span class="n">from_csv</span><span class="p">(</span><span class="s1">&#39;../ph/ads/&#39;</span><span class="p">,</span> 
                                <span class="s1">&#39;ads_upsampled.csv&#39;</span><span class="p">,</span>
                                <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;images&#39;</span><span class="p">,</span> 
                                <span class="n">fn_col</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> 
                                <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span>
                                <span class="n">item_tfms</span><span class="o">=</span><span class="n">Resize</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="n">ResizeMethod</span><span class="o">.</span><span class="n">Squish</span><span class="p">),</span>
                                <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">F1Score</span><span class="p">())</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>f1_score</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.924742</td>
      <td>0.963872</td>
      <td>0.645570</td>
      <td>00:12</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With a trained fastai model we can predict on a sample from Newspaper Navigator</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">predictor</span> <span class="o">=</span> <span class="n">nnPredict</span><span class="p">(</span><span class="n">learn</span><span class="p">,</span> <span class="n">try_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">predictor</span><span class="o">.</span><span class="n">predict_sample</span><span class="p">(</span><span class="s1">&#39;ads&#39;</span><span class="p">,</span><span class="s1">&#39;testinference&#39;</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="n">end_year</span><span class="o">=</span><span class="mi">1850</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This returns a <code>json</code> file for each year from the sample containing the original newspaper navigator data plus the predictions from your model</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;testinference/1850.json&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can access the 'decoded' predictions</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pred_decoded&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>text-only        50
illustrations    38
Name: pred_decoded, dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>or work with the probabilities directly</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">5</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0    0.152435
1    0.027183
2    0.096673
3    0.395800
4    0.957422
Name: illustrations_prob, dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Acknowledgment">Acknowledgment<a class="anchor-link" href="#Acknowledgment"> </a></h3><blockquote><p>This work was support by <a href="livingwithmachines.ac.uk/">Living with Machines</a>. This project, funded by the UK Research and Innovation (UKRI) Strategic Priority Fund, is a multidisciplinary collaboration delivered by the Arts and Humanities Research Council (AHRC), with The Alan Turing Institute, the British Library and the Universities of Cambridge, East Anglia, Exeter, and Queen Mary University of London.</p>
</blockquote>

</div>
</div>
</div>
</div>
 

